# 码弦（MaXian）独立实现计划

## 项目概述

将 Kilocode 完整功能迁移为**码弦（MaXian）**，作为独立内置功能集成到天和智开 IDE，显示在右侧边栏（AuxiliaryBar），与现有 AI Chat 完全独立，可以共存。

**码弦 = Kilocode 的完整 Agent 功能 + 只对接千问模型**

### 核心原则

1. **完全独立**：不依赖现有 AI Chat 的任何代码
2. **完整照搬**：保持 Kilocode 的完整功能和架构，只做必要的适配
3. **内置集成**：作为 Workbench 内置功能，不是独立扩展
4. **右侧显示**：使用 `ViewContainerLocation.AuxiliaryBar` 固定在右侧边栏
5. **逐步迁移**：从底层到上层，确保每个功能都能独立验证

---

## 目录结构

### 源码位置
```
/Users/caizhongrui/Downloads/kilocode-main/src/
```

### 目标位置
```
src/vs/workbench/contrib/maxian/  （码弦 - MaXian）
├── browser/                      # 浏览器环境代码
│   ├── maxianView.ts            # 主视图（使用 ViewContainerLocation.AuxiliaryBar）
│   ├── maxian.contribution.ts   # 注册和激活
│   ├── historyView.ts           # 历史记录视图
│   └── ...
├── common/                       # 公共代码
│   ├── maxianService.ts         # 核心服务接口
│   ├── types.ts                 # 类型定义
│   ├── tools/                   # 工具系统
│   ├── api/                     # API 层（千问适配）
│   ├── config/                  # 配置管理
│   ├── context/                 # 上下文管理
│   ├── prompts/                 # 提示词系统
│   ├── task/                    # 任务核心（Agent 引擎）
│   └── ...
├── electron-sandbox/            # Electron 环境特定代码
│   └── ...
└── node/                        # Node.js 环境代码
    └── ...
```

---

## 完整功能清单（共 50+ 个模块）

### 第一阶段：类型和基础设施（模块 1-10）

#### 模块 1：核心类型定义系统
**优先级**: P0（最高）
**依赖**: 无

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/shared/
├── ExtensionMessage.ts          # 扩展消息类型
├── tools.ts                     # 工具定义类型
├── modes.ts                     # 模式配置类型
├── experiments.ts               # 实验性功能类型
├── api.ts                       # API 配置类型
├── cost.ts                      # 成本计算类型
├── embeddingModels.ts           # 嵌入模型类型
├── array.ts                     # 数组工具函数
├── fs.ts                        # 文件系统工具
└── utils/                       # 工具函数
    ├── path.ts
    ├── extractTextFromFile.ts
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/shared/
```

**关键类型**:
- `ToolName`: 所有工具名称枚举
- `ToolParams`: 工具参数类型映射
- `ExtensionMessage`: WebView 消息类型
- `ApiConfiguration`: API 配置接口
- `ModelInfo`: 模型信息接口
- `ClineMessage`: Cline 消息类型（用户、助手、工具消息）

**验证标准**:
- [ ] TypeScript 编译通过，无类型错误
- [ ] 所有类型可以正确导入和使用
- [ ] 类型推导正常工作

---

#### 模块 2：工具函数库
**优先级**: P0
**依赖**: 模块 1

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/utils/
├── path.ts                      # 路径处理
├── extractTextFromFile.ts       # 文件内容提取
├── regexPatterns.ts             # 正则表达式模式
├── fs.ts                        # 文件系统工具
├── context.ts                   # 上下文工具
└── logging/                     # 日志系统
    ├── Logger.ts
    └── types.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/utils/
```

**核心功能**:
- 路径规范化和相对路径转换
- 文件内容提取（支持二进制文件检测）
- 正则表达式工具
- 日志记录系统
- VSCode 上下文工具

**验证标准**:
- [ ] 路径处理函数正常工作
- [ ] 文件内容可以正确提取
- [ ] 日志系统可以输出信息

---

#### 模块 3：文件系统服务 - Glob
**优先级**: P0
**依赖**: 模块 1, 2

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/services/glob/
├── list-files.ts                # 文件列表核心逻辑
├── __tests__/
│   └── list-files.spec.ts
└── __mocks__/
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/node/services/glob/
```

**核心功能**:
- 递归列出文件和目录
- 支持 .gitignore 和 .rooignore 过滤
- 文件大小统计
- 目录深度控制

**验证标准**:
- [ ] 可以列出目录中的所有文件
- [ ] .gitignore 规则正确应用
- [ ] 递归和非递归模式都正常

---

#### 模块 4：文件系统服务 - Ripgrep
**优先级**: P0
**依赖**: 模块 1, 2

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/services/ripgrep/
├── index.ts                     # Ripgrep 封装
├── __tests__/
│   └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/node/services/ripgrep/
```

**核心功能**:
- 基于 ripgrep 的文件内容搜索
- 支持正则表达式
- 支持文件类型过滤
- 支持 .rooignore 规则

**验证标准**:
- [ ] 可以搜索文件内容
- [ ] 正则表达式搜索正常
- [ ] 文件类型过滤有效

---

#### 模块 5：文件保护系统 - RooIgnore
**优先级**: P1
**依赖**: 模块 2, 3

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/ignore/
├── RooIgnoreController.ts       # .rooignore 控制器
├── __tests__/
│   ├── RooIgnoreController.spec.ts
│   └── RooIgnoreController.security.spec.ts
└── __mocks__/
    └── RooIgnoreController.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/ignore/
```

**核心功能**:
- .rooignore 文件解析
- 文件过滤规则
- 安全检查（防止读取敏感文件）
- 与 .gitignore 集成

**验证标准**:
- [ ] .rooignore 规则可以正确应用
- [ ] 敏感文件被正确过滤
- [ ] 与 .gitignore 协同工作

---

#### 模块 6：文件保护系统 - RooProtect
**优先级**: P1
**依赖**: 模块 2, 3

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/protect/
├── RooProtectedController.ts    # .rooprotect 控制器
└── __tests__/
    └── RooProtectedController.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/protect/
```

**核心功能**:
- .rooprotect 文件解析
- 保护文件不被 AI 修改
- 白名单模式支持

**验证标准**:
- [ ] .rooprotect 规则可以正确应用
- [ ] 保护的文件不能被工具修改
- [ ] 白名单模式正常工作

---

#### 模块 7：环境信息收集
**优先级**: P1
**依赖**: 模块 1, 2

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/environment/
├── get-shell-info.ts            # Shell 环境信息
├── __tests__/
│   └── get-shell-info.spec.ts
```

```
/Users/caizhongrui/Downloads/kilocode-main/src/integrations/workspace/
├── index.ts                     # 工作区信息
└── __tests__/
    └── index.spec.ts
```

```
/Users/caizhongrui/Downloads/kilocode-main/src/integrations/misc/
├── get-theme.ts                 # 主题信息
└── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/environment/
src/vs/workbench/contrib/kilocode/browser/integrations/workspace/
src/vs/workbench/contrib/kilocode/browser/integrations/misc/
```

**核心功能**:
- 操作系统信息（macOS/Windows/Linux）
- Shell 类型和版本（bash/zsh/powershell）
- 工作区路径信息
- VSCode 版本信息
- 当前主题信息

**验证标准**:
- [ ] 可以获取完整的环境信息
- [ ] 信息格式符合提示词要求

---

#### 模块 8：配置管理系统
**优先级**: P1
**依赖**: 模块 1, 2

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/config/
├── CustomModesManager.ts        # 自定义模式管理
├── ProviderSettingsManager.ts   # API 提供商设置管理
├── ContextProxy.ts              # 上下文代理
├── importExport.ts              # 导入导出配置
├── kilocode/
│   └── migrateMorphApiKey.ts
└── __tests__/
    ├── CustomModesManager.spec.ts
    ├── ProviderSettingsManager.spec.ts
    ├── ContextProxy.spec.ts
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/config/
```

**核心功能**:
- API 提供商配置（Anthropic、OpenAI 等）
- 自定义模式管理（Chat/Agent/Architect）
- 配置导入导出
- 上下文代理（访问 VSCode 配置）

**验证标准**:
- [ ] 可以读取和保存配置
- [ ] 模式切换正常
- [ ] 配置导入导出正常

---

#### 模块 9：Roo 配置文件服务
**优先级**: P2
**依赖**: 模块 1, 2

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/services/roo-config/
├── index.ts                     # .roo/config.json 处理
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/services/roo-config/
```

**核心功能**:
- .roo/config.json 读取和解析
- 项目级配置覆盖
- 配置验证

**验证标准**:
- [ ] 可以读取项目配置文件
- [ ] 配置正确应用

---

#### 模块 10：国际化系统
**优先级**: P2
**依赖**: 模块 1

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/i18n/
├── index.ts                     # i18next 初始化
├── locales/
│   ├── en/
│   │   └── translation.json
│   ├── zh-CN/
│   │   └── translation.json
│   ├── ja/
│   ├── ko/
│   ├── fr/
│   ├── de/
│   └── ... (23种语言)
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/i18n/
```

**核心功能**:
- i18next 配置
- 多语言支持（23种语言）
- 翻译函数 t()
- 语言切换

**验证标准**:
- [ ] 可以切换语言
- [ ] 翻译文本正确显示
- [ ] 支持所有语言

---

### 第二阶段：API 和消息处理（模块 11-17）

#### 模块 11：API 抽象层
**优先级**: P0（核心）
**依赖**: 模块 1, 8

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/api/
├── index.ts                     # API 主入口
├── buildApiHandler.ts           # API Handler 构建器
├── providers/
│   ├── anthropic.ts            # Anthropic SDK 封装
│   ├── openai.ts               # OpenAI SDK 封装
│   ├── openrouter.ts           # OpenRouter 适配器
│   ├── bedrock.ts              # AWS Bedrock 适配器
│   ├── vertex.ts               # Google Vertex AI 适配器
│   ├── openai-native.ts        # OpenAI 原生 SDK
│   ├── glama.ts                # Glama 适配器
│   ├── utils/
│   │   ├── cost.ts             # 成本计算
│   │   └── ...
│   ├── fetchers/
│   │   └── ...                 # 自定义 fetch 实现
│   └── __tests__/
│       └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/api/
```

**核心功能**:
- ApiHandler 基类和接口
- 统一的 API 调用接口
- 流式响应处理
- 错误处理和重试逻辑
- Token 计数
- 成本计算

**关键接口**:
```typescript
interface ApiHandler {
    createMessage(systemPrompt: string, messages: any[], tools: any[]): AsyncGenerator
    completePrompt(prompt: string): Promise<string>
    getModel(): { id: string, info: ModelInfo }
}
```

**验证标准**:
- [ ] ApiHandler 可以正确初始化
- [ ] 支持所有 API 提供商
- [ ] 错误处理正常工作
- [ ] Token 计数准确

---

#### 模块 12：消息格式转换
**优先级**: P0
**依赖**: 模块 11

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/api/transform/
├── index.ts                     # 转换主入口
├── openai-format.ts            # OpenAI 格式转换
├── anthropic-format.ts         # Anthropic 格式转换
├── caching/
│   ├── anthropic-cache.ts      # Anthropic 提示缓存
│   └── ...
├── cache-strategy/
│   └── ...                     # 缓存策略
└── __tests__/
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/api/transform/
```

**核心功能**:
- Anthropic ↔ OpenAI 消息格式互转
- 工具调用格式转换
- 图片内容转换
- Anthropic 提示缓存处理
- 缓存策略管理

**验证标准**:
- [ ] 消息格式转换正确
- [ ] 工具调用正常工作
- [ ] 图片可以正确传递
- [ ] 提示缓存有效

---

#### 模块 13：滑动窗口和上下文管理
**优先级**: P1
**依赖**: 模块 1, 11

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/sliding-window/
├── index.ts                     # truncateConversation 函数
└── __tests__/
    └── sliding-window.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/sliding-window/
```

**核心功能**:
- truncateConversation() - 对话历史截断
- 保留系统提示词（第一条消息）
- 确保截断后以 user 消息开始
- 按比例删除旧消息

**验证标准**:
- [ ] 消息历史可以正确截断
- [ ] 第一条系统消息始终保留
- [ ] 截断后格式正确（user -> assistant -> ...）

---

#### 模块 14：上下文压缩
**优先级**: P2
**依赖**: 模块 11

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/condense/
├── index.ts                     # 上下文压缩逻辑
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/condense/
```

**核心功能**:
- 使用 LLM 总结对话历史
- 减少 token 使用
- 保留关键信息

**验证标准**:
- [ ] 可以调用 LLM 进行总结
- [ ] 总结内容准确
- [ ] Token 显著减少

---

#### 模块 15：提示词系统
**优先级**: P0（核心）
**依赖**: 模块 1, 7, 8

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/prompts/
├── system.ts                    # 系统提示词生成
├── responses.ts                 # 响应格式化
├── sections/
│   ├── capabilities.ts         # 能力描述
│   ├── rules.ts                # 规则描述
│   ├── objective.ts            # 目标描述
│   └── ...
├── tools/
│   ├── index.ts                # 工具描述生成
│   └── ...
├── instructions/
│   └── ...                     # 指令模板
├── utilities/
│   └── ...                     # 工具函数
└── __tests__/
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/prompts/
```

**核心功能**:
- 生成完整的系统提示词
- 包含环境信息、工具描述、规则等
- 支持不同模式（Chat/Agent/Architect）
- 自定义规则注入
- 工作流支持

**验证标准**:
- [ ] 系统提示词可以正确生成
- [ ] 包含所有必要信息
- [ ] 不同模式生成不同提示词

---

#### 模块 16：上下文提供器
**优先级**: P1
**依赖**: 模块 1, 2, 3, 4

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/context/
├── instructions/
│   ├── kilo-rules.ts           # Kilo 规则
│   ├── workflows.ts            # 工作流
│   └── rule-helpers.ts         # 规则辅助函数
└── context-management/
    ├── context-error-handling.ts
    └── __tests__/
        └── context-error-handling.test.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/context/
```

**核心功能**:
- 自定义规则管理
- 工作流管理
- 上下文错误处理

**验证标准**:
- [ ] 可以加载和应用规则
- [ ] 工作流正常执行
- [ ] 错误处理正常

---

#### 模块 17：@提及系统
**优先级**: P1
**依赖**: 模块 1, 2, 3, 4

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/mentions/
├── index.ts                     # @提及解析
├── url-content-fetcher.ts      # URL 内容抓取
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/mentions/
```

**核心功能**:
- @文件 - 包含单个文件内容
- @文件夹 - 包含文件夹结构
- @网址 - 抓取网页内容
- @问题 - GitHub Issue 内容
- @代码 - 代码片段

**验证标准**:
- [ ] @文件可以正确解析和包含
- [ ] @文件夹可以列出结构
- [ ] @网址可以抓取内容

---

### 第三阶段：工具系统（模块 18-36）

#### 模块 18：工具基础设施
**优先级**: P0
**依赖**: 模块 1

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── ToolRepetitionDetector.ts    # 工具重复检测
├── validateToolUse.ts           # 工具使用验证
├── kilocode.ts                  # 工具定义聚合
└── __tests__/
    ├── ToolRepetitionDetector.spec.ts
    └── validateToolUse.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- ToolRepetitionDetector - 检测重复工具调用
- 工具参数验证
- 工具定义聚合

**验证标准**:
- [ ] 工具重复检测正常工作
- [ ] 参数验证有效
- [ ] 工具定义正确

---

#### 模块 19：文件读取工具
**优先级**: P0
**依赖**: 模块 3, 5, 6, 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── readFileTool.ts              # 完整文件读取
├── simpleReadFileTool.ts        # 简化文件读取
└── __tests__/
    └── readFileTool.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- read_file - 读取文件内容
- simple_read_file - 简化版读取
- 支持偏移和限制（offset, limit）
- 行号显示
- 二进制文件检测

**验证标准**:
- [ ] 可以读取文本文件
- [ ] 偏移和限制参数有效
- [ ] 二进制文件被正确处理

---

#### 模块 20：文件写入工具
**优先级**: P0
**依赖**: 模块 3, 5, 6, 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── writeToFileTool.ts           # 文件写入
└── __tests__/
    └── writeToFileTool.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- write_to_file - 创建或覆盖文件
- 目录自动创建
- 权限检查（.rooprotect）

**验证标准**:
- [ ] 可以创建新文件
- [ ] 可以覆盖现有文件
- [ ] 受保护文件不能写入

---

#### 模块 21：Diff 系统
**优先级**: P0（核心）
**依赖**: 模块 2, 3, 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/diff/
├── strategies/
│   ├── SearchReplace.ts        # 搜索替换策略
│   ├── BlockReplacement.ts     # 块替换策略
│   ├── UnifiedDiff.ts          # 统一 Diff
│   └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/diff/
```

**核心功能**:
- 多种 Diff 策略
- 搜索替换（支持模糊匹配）
- 块替换（基于行号）
- 统一 Diff 格式
- 相似度计算（Levenshtein 距离）

**验证标准**:
- [ ] 搜索替换策略正常
- [ ] 块替换策略正常
- [ ] 模糊匹配有效

---

#### 模块 22：文件编辑工具
**优先级**: P0
**依赖**: 模块 21

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── applyDiffTool.ts            # 应用 Diff（搜索替换）
├── editFileTool.ts             # 编辑文件（Morph fast apply）
├── insertContentTool.ts        # 插入内容
├── multiApplyDiffTool.ts       # 多文件 Diff
└── __tests__/
    ├── applyDiffTool.experiment.spec.ts
    ├── insertContentTool.spec.ts
    └── multiApplyDiffTool.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- apply_diff - 搜索替换式编辑
- edit_file - 基于行号的快速编辑
- insert_content - 在指定位置插入内容
- multi_apply_diff - 一次编辑多个文件

**验证标准**:
- [ ] apply_diff 可以正确编辑
- [ ] edit_file 快速编辑有效
- [ ] insert_content 插入正确
- [ ] 多文件编辑正常

---

#### 模块 23：文件浏览工具
**优先级**: P0
**依赖**: 模块 3, 4, 5, 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── listFilesTool.ts            # 列出文件
├── searchFilesTool.ts          # 搜索文件内容
└── __tests__/
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- list_files - 列出文件和目录
- search_files - 搜索文件内容（ripgrep）
- 支持递归列表
- 支持文件过滤

**验证标准**:
- [ ] 可以列出文件和目录
- [ ] 搜索内容准确
- [ ] 过滤规则有效

---

#### 模块 24：代码定义提取工具
**优先级**: P1
**依赖**: 模块 18, 模块 39（Tree-sitter）

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── listCodeDefinitionNamesTool.ts  # 列出代码定义
├── helpers/
│   ├── truncateDefinitions.ts     # 定义截断
│   ├── fileTokenBudget.ts         # Token 预算管理
│   └── __tests__/
│       ├── truncateDefinitions.spec.ts
│       └── fileTokenBudget.spec.ts
└── __tests__/
    └── listCodeDefinitionNamesTool.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- list_code_definition_names - 列出函数、类、方法等
- 使用 Tree-sitter 解析
- 支持多种语言
- Token 预算管理

**验证标准**:
- [ ] 可以提取代码定义
- [ ] 支持主流编程语言
- [ ] Token 预算有效

---

#### 模块 25：语义搜索工具
**优先级**: P2
**依赖**: 模块 18, 模块 40（代码索引）

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── codebaseSearchTool.ts       # 代码库语义搜索
└── __tests__/
    └── codebaseSearchTool.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- codebase_search - 基于语义的代码搜索
- 使用向量嵌入
- 相似度排序

**验证标准**:
- [ ] 语义搜索返回相关结果
- [ ] 结果按相关度排序

---

#### 模块 26：终端命令工具
**优先级**: P1
**依赖**: 模块 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── executeCommandTool.ts       # 执行命令
└── __tests__/
    ├── executeCommandTool.spec.ts
    ├── executeCommand.spec.ts
    └── executeCommandTimeout.integration.spec.ts
```

```
/Users/caizhongrui/Downloads/kilocode-main/src/integrations/terminal/
├── index.ts                     # 终端集成
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
src/vs/workbench/contrib/kilocode/browser/integrations/terminal/
```

**核心功能**:
- execute_command - 执行终端命令
- 实时输出捕获
- 超时控制
- 工作目录支持

**验证标准**:
- [ ] 可以执行命令
- [ ] 可以获取输出
- [ ] 超时控制有效

---

#### 模块 27：浏览器自动化工具
**优先级**: P2
**依赖**: 模块 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── browserActionTool.ts        # 浏览器操作
```

```
/Users/caizhongrui/Downloads/kilocode-main/src/services/browser/
├── index.ts                     # Puppeteer 封装
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
src/vs/workbench/contrib/kilocode/node/services/browser/
```

**核心功能**:
- browser_action - 浏览器操作
- Puppeteer 集成
- 支持 launch、click、type、scroll 等操作
- 截图功能

**验证标准**:
- [ ] 可以启动浏览器
- [ ] 可以执行操作
- [ ] 可以获取截图

---

#### 模块 28：MCP 工具集成
**优先级**: P2
**依赖**: 模块 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── useMcpToolTool.ts           # 使用 MCP 工具
├── accessMcpResourceTool.ts    # 访问 MCP 资源
└── __tests__/
    └── useMcpToolTool.spec.ts
```

```
/Users/caizhongrui/Downloads/kilocode-main/src/services/mcp/
├── index.ts                     # MCP 服务器管理
├── __tests__/
│   └── index.spec.ts
└── kilocode/
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
src/vs/workbench/contrib/kilocode/node/services/mcp/
```

**核心功能**:
- use_mcp_tool - 调用 MCP 工具
- access_mcp_resource - 访问 MCP 资源
- MCP 服务器连接管理
- 工具发现和调用

**验证标准**:
- [ ] 可以连接 MCP 服务器
- [ ] 可以列出可用工具
- [ ] 可以调用工具

---

#### 模块 29：任务管理工具
**优先级**: P1
**依赖**: 模块 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── attemptCompletionTool.ts    # 完成任务
├── askFollowupQuestionTool.ts  # 询问问题
├── updateTodoListTool.ts       # 更新 TODO 列表
├── newTaskTool.ts              # 创建新任务
├── switchModeTool.ts           # 切换模式
└── __tests__/
    ├── attemptCompletionTool.spec.ts
    ├── askFollowupQuestionTool.spec.ts
    ├── updateTodoListTool.spec.ts
    └── newTaskTool.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- attempt_completion - 完成任务并展示结果
- ask_followup_question - 向用户询问问题
- update_todo_list - 管理 TODO 列表
- new_task - 创建子任务
- switch_mode - 切换模式（Chat/Agent/Architect）

**验证标准**:
- [ ] 任务可以正确完成
- [ ] 可以询问用户问题
- [ ] TODO 列表正常更新
- [ ] 可以创建子任务
- [ ] 模式切换正常

---

#### 模块 30：其他工具
**优先级**: P2
**依赖**: 模块 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/
├── fetchInstructionsTool.ts    # 获取指令
├── runSlashCommandTool.ts      # 运行斜杠命令
├── generateImageTool.ts        # 生成图片
├── newRuleTool.ts              # 创建新规则
├── reportBugTool.ts            # 报告 Bug
├── condenseTool.ts             # 压缩上下文
└── __tests__/
    ├── runSlashCommandTool.spec.ts
    └── generateImageTool.test.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/
```

**核心功能**:
- fetch_instructions - 获取预定义指令
- run_slash_command - 执行斜杠命令
- generate_image - 生成图片（实验性）
- new_rule - 创建自定义规则
- report_bug - 报告问题
- condense - 压缩对话上下文

**验证标准**:
- [ ] 各工具可以正常调用
- [ ] 功能符合预期

---

#### 模块 31-36：图片处理助手
**优先级**: P2
**依赖**: 模块 18

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/tools/helpers/
├── imageHelpers.ts             # 图片处理
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/tools/helpers/
```

**核心功能**:
- 图片转 Base64
- 图片格式检测
- 图片大小限制

**验证标准**:
- [ ] 可以处理图片
- [ ] 格式正确

---

### 第四阶段：核心任务系统（模块 37-43）

#### 模块 37：消息处理和工具执行
**优先级**: P0（核心）
**依赖**: 所有工具模块（18-36）

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/assistant-message/
├── index.ts                     # 主入口
├── presentAssistantMessage.ts  # 展示助手消息
├── parseAssistantMessage.ts    # 解析助手消息
├── __tests__/
│   └── ...
└── kilocode/
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/assistant-message/
```

**核心功能**:
- presentAssistantMessage - 处理助手响应
- parseAssistantMessage - 解析流式消息
- 工具执行循环
- 工具审批机制
- 错误处理

**验证标准**:
- [ ] 可以解析助手消息
- [ ] 可以执行工具
- [ ] 工具审批正常
- [ ] 错误处理有效

---

#### 模块 38：任务持久化
**优先级**: P1
**依赖**: 模块 1, 2

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/task-persistence/
├── index.ts                     # 主入口
├── taskMessages.ts             # 任务消息存储
├── apiMessages.ts              # API 消息存储
├── taskMetadata.ts             # 任务元数据
└── __tests__/
    └── taskMessages.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/task-persistence/
```

**核心功能**:
- 任务历史存储到文件系统
- API 消息记录
- 任务元数据管理
- 任务恢复

**验证标准**:
- [ ] 任务可以保存
- [ ] 任务可以加载和恢复
- [ ] 元数据正确

---

#### 模块 39：检查点系统
**优先级**: P1
**依赖**: 模块 38

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/checkpoints/
├── index.ts                     # 检查点主逻辑
├── __tests__/
│   └── index.spec.ts
└── kilocode/
    └── ...
```

```
/Users/caizhongrui/Downloads/kilocode-main/src/services/checkpoints/
├── index.ts                     # 检查点服务
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/checkpoints/
src/vs/workbench/contrib/kilocode/common/services/checkpoints/
```

**核心功能**:
- 创建检查点（快照）
- 恢复到检查点
- 检查点管理

**验证标准**:
- [ ] 可以创建检查点
- [ ] 可以恢复到检查点

---

#### 模块 40：消息队列
**优先级**: P1
**依赖**: 模块 1

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/message-queue/
├── index.ts                     # 消息队列
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/message-queue/
```

**核心功能**:
- 消息队列管理
- 优先级处理
- 异步消息处理

**验证标准**:
- [ ] 消息可以正确入队和出队
- [ ] 优先级有效

---

#### 模块 41：Task 核心类
**优先级**: P0（最核心）
**依赖**: 几乎所有之前的模块

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/task/
├── Task.ts                      # Task 核心类（3000+ 行）
├── types.ts                     # 任务类型定义
├── AutoApprovalHandler.ts      # 自动审批处理
└── __tests__/
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/task/
```

**核心功能**:
- Task 类 - 任务核心逻辑
- recursivelyMakeClineRequests - 递归调用 API
- attemptApiRequest - API 请求处理
- 任务生命周期管理
- 自动审批处理
- 状态管理（进行中、完成、中止等）

**关键方法**:
```typescript
class Task {
    async start(): Promise<void>
    async handleMessage(message: ClineMessage): Promise<void>
    async abort(): Promise<void>
    async resumeTask(): Promise<void>
}
```

**验证标准**:
- [ ] Task 可以成功创建
- [ ] 可以发起 API 请求
- [ ] 工具执行循环正常
- [ ] 任务可以完成或中止
- [ ] 任务可以暂停和恢复

---

#### 模块 42：斜杠命令
**优先级**: P2
**依赖**: 模块 1, 2, 41

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/slash-commands/
├── index.ts                     # 斜杠命令解析和执行
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/slash-commands/
```

**核心功能**:
- 斜杠命令解析
- 预定义命令执行
- 自定义命令支持

**验证标准**:
- [ ] 可以解析斜杠命令
- [ ] 预定义命令可以执行

---

#### 模块 43：上下文追踪
**优先级**: P1
**依赖**: 模块 1, 3

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/context-tracking/
├── index.ts                     # 上下文追踪
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/core/context-tracking/
```

**核心功能**:
- 追踪已使用的文件
- 追踪工具调用历史
- 上下文统计

**验证标准**:
- [ ] 可以追踪文件使用
- [ ] 统计信息准确

---

### 第五阶段：高级服务（模块 44-48）

#### 模块 44：Tree-sitter 代码解析
**优先级**: P2
**依赖**: 模块 2

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/services/tree-sitter/
├── index.ts                     # Tree-sitter 封装
├── queries/                     # 查询文件
│   ├── typescript.scm
│   ├── python.scm
│   ├── java.scm
│   └── ...
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/node/services/tree-sitter/
```

**核心功能**:
- Tree-sitter 解析器
- 代码定义提取（函数、类、方法等）
- 支持多种语言

**验证标准**:
- [ ] 可以解析代码文件
- [ ] 可以提取定义
- [ ] 支持主流语言

---

#### 模块 45：代码索引和语义搜索
**优先级**: P2
**依赖**: 模块 11, 44

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/services/code-index/
├── index.ts                     # 代码索引主入口
├── interfaces/
│   └── ...                     # 接口定义
├── embedders/
│   └── ...                     # 向量嵌入器
├── processors/
│   └── ...                     # 代码处理器
├── vector-store/
│   └── ...                     # 向量存储
├── constants/
│   └── ...                     # 常量定义
├── shared/
│   └── ...                     # 共享工具
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/node/services/code-index/
```

**核心功能**:
- 代码索引构建
- 向量嵌入（使用 Embeddings API）
- 语义搜索
- 增量索引更新

**验证标准**:
- [ ] 可以构建索引
- [ ] 语义搜索返回相关结果
- [ ] 索引可以更新

---

#### 模块 46：提交消息生成
**优先级**: P2
**依赖**: 模块 11

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/services/commit-message/
├── index.ts                     # 提交消息生成
├── adapters/
│   └── ...                     # 适配器
├── types/
│   └── ...                     # 类型定义
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/node/services/commit-message/
```

**核心功能**:
- Git diff 分析
- 使用 LLM 生成提交消息
- 提交消息优化

**验证标准**:
- [ ] 可以生成合适的提交消息
- [ ] 消息符合规范

---

#### 模块 47：自动清理服务
**优先级**: P3
**依赖**: 模块 38

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/services/auto-purge/
├── index.ts                     # 自动清理旧任务
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/services/auto-purge/
```

**核心功能**:
- 自动清理旧任务历史
- 保留最近的任务
- 磁盘空间管理

**验证标准**:
- [ ] 旧任务被正确清理
- [ ] 最近任务保留

---

#### 模块 48：其他服务
**优先级**: P3

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/services/
├── ghost/                       # Ghost 代码补全（实验性）
├── marketplace/                 # 市场服务
├── mdm/                         # MDM 服务
├── command/                     # 命令服务
├── continuedev/                 # Continue.dev 集成
├── mocking/                     # Mock 服务
├── terminal-welcome/            # 终端欢迎信息
└── search/                      # 搜索服务
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/node/services/
```

**核心功能**:
- 各种辅助服务

**验证标准**:
- [ ] 按需验证

---

### 第六阶段：UI 和视图（模块 49-52）

#### 模块 49：Webview Provider（核心 UI）
**优先级**: P0
**依赖**: 模块 41

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/core/webview/
├── ClineProvider.ts            # 主 WebView Provider
├── HistoryViewProvider.ts      # 历史视图 Provider
├── kilorules.ts                # Kilo 规则
└── __tests__/
    └── ...
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/browser/core/webview/
```

**核心功能**:
- ClineProvider - 主视图提供器
- HistoryViewProvider - 历史视图
- WebView 消息通信
- 状态管理和同步
- 任务创建和管理

**关键方法**:
```typescript
class ClineProvider {
    async postMessageToWebview(message: any): Promise<void>
    async handleWebviewMessage(message: any): Promise<void>
    async createTask(params: any): Promise<void>
}
```

**验证标准**:
- [ ] WebView 可以正常显示
- [ ] 消息通信正常
- [ ] 任务可以创建和管理
- [ ] 状态同步正常

---

#### 模块 50：编辑器集成
**优先级**: P1
**依赖**: 模块 41, 49

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/integrations/editor/
├── index.ts                     # 编辑器集成
├── DiffViewProvider.ts         # Diff 预览
├── decoration.ts               # 编辑器装饰器
└── __tests__/
    └── index.spec.ts
```

```
/Users/caizhongrui/Downloads/kilocode-main/src/integrations/diagnostics/
├── index.ts                     # 诊断信息集成
└── __tests__/
    └── index.spec.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/browser/integrations/editor/
src/vs/workbench/contrib/kilocode/browser/integrations/diagnostics/
```

**核心功能**:
- 编辑器装饰器（高亮修改的行）
- Diff 预览
- 诊断信息集成

**验证标准**:
- [ ] 文件修改可以在编辑器中显示
- [ ] Diff 预览正常工作
- [ ] 诊断信息正常

---

#### 模块 51：通知和其他集成
**优先级**: P2
**依赖**: 模块 49

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/integrations/
├── notifications/               # 通知
├── theme/                       # 主题
└── claude-code/                 # Claude Code 集成
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/browser/integrations/
```

**核心功能**:
- 通知显示
- 主题适配
- 其他集成

**验证标准**:
- [ ] 通知可以正常显示
- [ ] 主题切换正常

---

#### 模块 52：激活和注册
**优先级**: P0
**依赖**: 模块 41, 49

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/activate/
├── index.ts                     # 激活逻辑
└── __tests__/
    └── index.spec.ts
```

```
/Users/caizhongrui/Downloads/kilocode-main/src/extension.ts
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/browser/kilocode.contribution.ts
src/vs/workbench/contrib/kilocode/browser/kilocodeView.ts
```

**核心功能（需要适配为内置功能）**:
```typescript
// kilocode.contribution.ts - 注册视图容器和视图

import { ViewContainerLocation } from 'vs/workbench/common/views';
import { Registry } from 'vs/platform/registry/common/platform';
import { SyncDescriptor } from 'vs/platform/instantiation/common/descriptors';

// 1. 注册视图容器（右侧边栏）
const kilocodeViewContainer = viewContainerRegistry.registerViewContainer({
    id: 'kilocode',
    title: localize2('kilocode.viewContainer.title', 'Kilocode'),
    icon: Codicon.robot,  // 选择合适的图标
    order: 20,            // 在 AI Chat 之后
    ctorDescriptor: new SyncDescriptor(ViewPaneContainer, ['kilocode', { mergeViewWithContainerWhenSingleView: true }]),
    storageId: 'kilocode',
    hideIfEmpty: false
}, ViewContainerLocation.AuxiliaryBar); // 右侧边栏

// 2. 注册视图
viewsRegistry.registerViews([{
    id: 'kilocode.mainView',
    name: localize2('kilocode.view.name', 'Kilocode Agent'),
    containerIcon: kilocodeViewContainer.icon,
    ctorDescriptor: new SyncDescriptor(KilocodeView),
    order: 1,
    weight: 100,
    collapsed: false,
    canToggleVisibility: true,
    hideByDefault: false,
    canMoveView: true
}], kilocodeViewContainer);

// 3. 注册命令
CommandsRegistry.registerCommand('kilocode.newTask', ...);
CommandsRegistry.registerCommand('kilocode.openHistory', ...);
// ... 其他命令

// 4. 注册服务
registerSingleton(IKilocodeService, KilocodeService, InstantiationType.Delayed);
```

**验证标准**:
- [ ] Kilocode 视图容器在右侧边栏显示
- [ ] 视图可以正常打开
- [ ] 命令可以执行
- [ ] 服务可以注入

---

### 第七阶段：资源和配置（模块 53-55）

#### 模块 53：静态资源
**优先级**: P1

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/assets/
├── icons/                       # 图标
├── images/                      # 图片
├── docs/                        # 文档
└── codicons/                    # Codicon 图标
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/browser/media/
```

**核心功能**:
- 静态资源文件
- 图标和图片
- 文档资源

**验证标准**:
- [ ] 资源可以正确加载

---

#### 模块 54：Walkthrough（入门指南）
**优先级**: P2

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/src/walkthrough/
├── index.ts
└── images/
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/browser/walkthrough/
```

**核心功能**:
- 用户入门指南
- 功能介绍

**验证标准**:
- [ ] Walkthrough 可以显示

---

#### 模块 55：Package 和类型定义
**优先级**: P0

**源文件结构**:
```
/Users/caizhongrui/Downloads/kilocode-main/packages/
├── types/                       # 类型定义包
├── telemetry/                   # 遥测包
└── cloud/                       # 云服务包
```

**目标位置**:
```
src/vs/workbench/contrib/kilocode/common/packages/
```

**核心功能**:
- 独立的类型定义包
- 遥测功能（可选）
- 云服务集成（可选）

**验证标准**:
- [ ] 类型定义可用
- [ ] 遥测功能正常（如果启用）

---

## 迁移进度跟踪表（按开发顺序 - 码弦 Agent 系统）

| 序号 | 模块 | 原阶段 | 优先级 | 状态 | 完成日期 | 备注 |
|------|------|--------|--------|------|----------|------|
| 1 | 核心类型定义系统 | 一 | P0 | ⬜ 未开始 | - | 工具类型、消息类型等 |
| 2 | WebView Provider（基础 UI） | 六 | P0 | ⬜ 未开始 | - | 码弦独立 UI 界面 |
| 3 | 静态资源 | 七 | P1 | ⬜ 未开始 | - | 图标、样式等 |
| 4 | 工具函数库 | 一 | P0 | ✅ 已完成 | 2025-11-14 | **6个核心文件**：toolTypes.ts, toolExecutor.ts, fileOperations.ts, commandExecution.ts, searchTools.ts, toolExecutorImpl.ts；**13种工具**：read_file, write_to_file, list_files, execute_command, search_files, codebase_search, ask_followup_question, attempt_completion, new_task, update_todo_list等；**已集成到MaxianService** |
| 5 | 千问 API 适配层 | 二 | P0 | ✅ 已完成 | 2025-11-14 | **3个核心文件**：types.ts（API类型定义）、qwenHandler.ts（千问API实现）、apiFactory.ts（API工厂）；**已集成到MaxianService**；支持流式响应、工具调用、Token计数；使用智开配置（zhikai.ai.*） |
| 6 | 提示词系统（完整版） | 二 | P0 | ✅ 已完成 | 2025-11-14 | **5个section文件 + 2个核心文件**：rules.ts、capabilities.ts、systemInfo.ts、objective.ts、toolUseGuidelines.ts、systemPrompt.ts、toolDescriptions.ts；**完整提示词系统**：角色定义、工具描述、使用指南、能力说明、规则、系统信息、目标；**13种工具详细描述**；参考Kilocode完整实现 |
| 7 | 文件系统 - Glob | 一 | P0 | ✅ 已完成 | 2025-11-15 | **4个核心文件**：globConstants.ts（忽略目录列表）、ignoreUtils.ts（路径过滤工具）、listFilesService.ts（完整移植Kilocode list-files.ts，690行）；**完整功能**：文件+目录列表（目录以"/"结尾）、.gitignore支持（ignore库）、递归/非递归模式、首层目录优先、ScanContext模式、特殊目录处理；**已集成**：fileOperations.ts的listFiles()和glob()方法使用完整实现；**逻辑效果**：与Kilocode 100%一致 |
| 8 | 文件系统 - Ripgrep | 一 | P0 | ✅ 已完成 | 2025-11-15 | **2个核心文件**：ripgrepSearchService.ts（完整移植Kilocode ripgrep/index.ts，267行）；searchTools.ts更新codebaseSearch()；**完整功能**：正则表达式搜索（Rust regex）、上下文显示（-C 1）、JSON输出解析、格式化结果（行号+管道符）、file_pattern过滤、最多300个结果；**已集成**：SearchTool使用regexSearchFiles()、maxianService通过toolExecutor调用；**逻辑效果**：与Kilocode regexSearchFiles() 100%一致 |
| 9 | 工具基础设施 | 三 | P0 | ✅ 已完成（简化版） | 2025-11-15 | **3个核心文件**：ToolRepetitionDetector.ts（121行，检测重复工具调用）、i18n/index.ts（简化国际化，支持中文）、taskTypes.ts（Task类型定义）；**功能**：工具重复检测、错误限制、国际化翻译；**备注**：简化版实现，去除了MCP、RooIgnore等复杂依赖 |
| 10 | 文件读取工具 | 三 | P0 | ⬜ 未开始 | - | read_file |
| 11 | 文件写入工具 | 三 | P0 | ⬜ 未开始 | - | write_to_file |
| 12 | Diff 系统 | 三 | P0 | ✅ 已完成 | 2025-11-15 | **5个核心文件**：textNormalization.ts（文本规范化110行）、lineNumbers.ts（行号处理95行）、levenshtein.ts（Levenshtein距离算法80行）、insertGroups.ts（数组插入49行）、MultiSearchReplaceDiffStrategy.ts（完整Diff策略687行）；**核心功能**：多重搜索替换（SEARCH/REPLACE块）、模糊匹配（Levenshtein距离相似度）、行号定位（:start_line:）、中间向外搜索算法、缩进保留、转义标记支持、标记序列验证、进度状态显示；**算法特性**：Levenshtein距离计算、智能引号归一化、多行匹配、aggressive行号剥离；**错误处理**：详细的错误提示、最佳匹配显示、相似度百分比；**完整实现**：与Kilocode 100%功能一致，支持多个Diff块、自动检测行结束符、保留原始缩进 |
| 13 | 文件编辑工具 | 三 | P0 | ⬜ 未开始 | - | apply_diff、edit_file |
| 14 | 文件浏览工具 | 三 | P0 | ⬜ 未开始 | - | list_files、search_files |
| 15 | 提示词系统（完整） | 二 | P0 | ⬜ 未开始 | - | 包含工具描述、规则等 |
| 16 | 消息处理和工具执行 | 四 | P0 | ✅ 已完成 | 2025-11-15 | **集成文件**：maxianService.ts集成TaskService；**核心功能**：sendMessage()创建TaskService实例、事件连接（onStatusChanged→onMessage、onMessageAdded→onMessage）、getTaskStatus()返回实际状态；**工具执行循环**：TaskService.start()→recursivelyMakeClineRequests()→executeTools()；**流式消息处理**：通过事件系统实时反馈；**错误处理**：完整的错误捕获和用户反馈 |
| 17 | 滑动窗口 | 二 | P1 | ⬜ 未开始 | - | 对话历史截断 |
| 18 | 终端命令工具 | 三 | P1 | ⬜ 未开始 | - | execute_command |
| 19 | 任务管理工具 | 三 | P1 | ⬜ 未开始 | - | attempt_completion 等 |
| 20 | 任务持久化 | 四 | P1 | ⬜ 未开始 | - | 任务历史存储 |
| 21 | 消息队列 | 四 | P1 | ⬜ 未开始 | - | 消息队列管理 |
| 22 | Task 核心类 | 四 | P0 | ✅ 已完成（简化版） | 2025-11-15 | **核心文件**：TaskService.ts（500+行）；**核心功能**：recursivelyMakeClineRequests()循环、attemptApiRequest()（带重试）、processApiStream()、executeTools()（含重复检测）、错误处理（指数退避）、事件系统（onStatusChanged、onMessageAdded、onTokenUsageUpdated）；**状态管理**：IDLE→PROCESSING→COMPLETED/ERROR/ABORTED；**限制**：MAX_ITERATIONS=25、MAX_CONSECUTIVE_MISTAKES=3；**简化点**：去除MCP、检查点、复杂审批流程 |
| 23 | 编辑器集成 | 六 | P1 | ⬜ 未开始 | - | Diff 预览、装饰器 |
| 24 | RooIgnore | 一 | P1 | ⬜ 未开始 | - | 文件过滤规则 |
| 25 | RooProtect | 一 | P1 | ⬜ 未开始 | - | 文件保护 |
| 26 | 上下文提供器 | 二 | P1 | ⬜ 未开始 | - | 自定义规则、工作流 |
| 27 | @提及系统 | 二 | P1 | ⬜ 未开始 | - | @文件、@文件夹、@网址 |
| 28 | 环境信息收集 | 一 | P1 | ⬜ 未开始 | - | OS、Shell、工作区信息 |
| 29 | 上下文追踪 | 四 | P1 | ⬜ 未开始 | - | 追踪已使用文件 |
| 30 | 代码定义提取工具 | 三 | P1 | ⬜ 未开始 | - | list_code_definition_names |
| 31 | 检查点系统 | 四 | P1 | ⬜ 未开始 | - | 任务检查点 |
| 32 | 国际化系统 | 一 | P2 | ⬜ 未开始 | - | 多语言支持 |
| 33 | 上下文压缩 | 二 | P2 | ⬜ 未开始 | - | LLM 总结 |
| 34 | 语义搜索工具 | 三 | P2 | ⬜ 未开始 | - | codebase_search |
| 35 | 浏览器自动化工具 | 三 | P2 | ⬜ 未开始 | - | browser_action |
| 36 | MCP 工具集成 | 三 | P2 | ⬜ 未开始 | - | use_mcp_tool |
| 37 | 其他工具 | 三 | P2 | ⬜ 未开始 | - | 斜杠命令、生成图片等 |
| 38 | 斜杠命令 | 四 | P2 | ⬜ 未开始 | - | 斜杠命令解析执行 |
| 39 | Tree-sitter | 五 | P2 | ⬜ 未开始 | - | 代码解析 |
| 40 | 代码索引 | 五 | P2 | ⬜ 未开始 | - | 语义搜索索引 |
| 41 | 提交消息生成 | 五 | P2 | ⬜ 未开始 | - | Git commit 消息 |

### 关键里程碑

- ✅ **序号 1-3 完成**：独立 UI 界面显示在右侧边栏
- ✅ **序号 1-6 完成**：可以在 UI 中进行基本对话（千问）
- ✅ **序号 1-14 完成**：所有文件操作工具可用，可在 UI 中测试
- ✅ **序号 1-16 完成**：工具执行循环完成，Agent 基本可用
- ✅ **序号 1-22 完成**：完整 Agent 功能可用（Task 核心）
- ✅ **序号 1-31 完成**：核心功能全部完成
- ✅ **序号 1-41 完成**：所有功能完成

### 说明

**码弦（MaXian）- 完整 Agent 系统**（共 41 个模块）：
- ✅ **Agent 模式**：完整的 Kilocode Agent 功能（工具调用、任务执行）
- ✅ **独立视图**：右侧边栏独立视图容器，与 AI Chat 共存
- ✅ **独立 UI**：完整的 WebView 界面（序号 2）
- ✅ **独立资源**：图标、样式等静态资源（序号 3）
- ✅ **Task 引擎**：完整的任务执行引擎（序号 22 - 最核心）
- ✅ **工具系统**：所有文件操作、终端、浏览器等工具（序号 7-19）
- ❌ **只对接千问**：简化 API 层，不支持 Anthropic、OpenAI 等
- ❌ **简化配置**：使用智开配置，只需一个 API Key
- ❌ **无需激活**：作为内置功能，自动可用，不需要激活和注册模块

**核心定位**：码弦 = 智开 IDE 的 AI Agent 助手（类似 Cursor 的 Agent 模式）

---

## 每个模块的迁移流程

### 标准流程

#### 1. 准备阶段（30 分钟）
- [ ] 阅读 Kilocode 源码，理解功能
- [ ] 确认依赖模块已完成
- [ ] 查看相关测试用例
- [ ] 规划适配点

#### 2. 迁移阶段（2-4 小时）
- [ ] 创建目标目录
- [ ] 复制源文件到目标位置
- [ ] 调整 import 路径（`.js` 后缀、相对路径等）
- [ ] 适配 VSCode 内置 API（如果需要）
- [ ] 添加文件头注释：`// Copied from Kilocode`
- [ ] 标记修改：`// Adapted for tianhe-zhikai-ide: ...`

#### 3. 编译阶段（1 小时）
- [ ] 运行 `yarn compile`
- [ ] 修复 TypeScript 错误
- [ ] 确保无编译错误

#### 4. 验证阶段（1-2 小时）
- [ ] 创建简单测试用例
- [ ] 运行 `./scripts/code.sh` 启动
- [ ] 手动测试功能
- [ ] 确认功能正常工作

#### 5. 文档阶段（30 分钟）
- [ ] 更新迁移进度表
- [ ] 记录遇到的问题和解决方案
- [ ] 记录适配点和修改

---

## 路径调整规则

### Import 路径转换

```typescript
// Kilocode 原始（相对路径）
import { Task } from './core/task/Task'
import * as vscode from 'vscode'
import { ToolName } from '../shared/tools'

// 迁移后（VSCode 内置模块路径）
import { Task } from 'vs/workbench/contrib/kilocode/common/core/task/Task'
import * as vscode from 'vscode'  // 保持不变（如果使用）
import { ToolName } from 'vs/workbench/contrib/kilocode/common/shared/tools'
```

### 文件扩展名规则

```typescript
// Kilocode 原始
import { foo } from './bar'

// 迁移后（必须加 .js 后缀）
import { foo } from './bar.js'
```

---

## VSCode API 适配指南

### 1. 大部分代码无需修改
Kilocode 本身就是 VSCode 扩展，使用的是标准 VSCode API，可以直接使用。

### 2. 需要适配的部分

#### ExtensionContext
```typescript
// Kilocode 扩展
function activate(context: vscode.ExtensionContext) {
    const provider = new ClineProvider(context);
}

// 内置功能适配
class KilocodeView extends ViewPane {
    constructor(
        @IInstantiationService private readonly instantiationService: IInstantiationService,
        @IStorageService private readonly storageService: IStorageService,
        // ... 其他服务
    ) {
        // 使用注入的服务替代 context
    }
}
```

#### 配置读取
```typescript
// Kilocode 扩展
const config = vscode.workspace.getConfiguration('kilocode');

// 内置功能（可以继续使用 vscode API）
const config = vscode.workspace.getConfiguration('kilocode');
// 或使用 IConfigurationService
this.configurationService.getValue('kilocode.xxx');
```

#### 文件系统
```typescript
// Kilocode 使用 Node.js fs
import * as fs from 'fs';

// 内置功能（继续使用 Node.js fs 或使用 VSCode 的文件服务）
import * as fs from 'fs';  // 仍然可用
// 或
this.fileService.readFile(uri);
```

---

## 依赖管理

### NPM 依赖（需要添加到主项目）

```json
{
  "dependencies": {
    "@anthropic-ai/sdk": "^0.x.x",
    "openai": "^4.x.x",
    "tree-sitter": "^0.x.x",
    "tree-sitter-typescript": "^0.x.x",
    "tree-sitter-python": "^0.x.x",
    "tree-sitter-java": "^0.x.x",
    // ... 其他语言的 tree-sitter
    "i18next": "^23.x.x",
    "puppeteer": "^21.x.x",
    "diff": "^5.x.x"
  }
}
```

### 二进制依赖

- **ripgrep**: 已内置于 VSCode
- **tree-sitter**: 需要编译原生模块

---

## 测试策略

### 单元测试
- 保留 Kilocode 的测试用例
- 适配路径和导入
- 确保核心功能有测试覆盖

### 集成测试
- 创建端到端测试
- 测试完整任务执行流程

### 手动测试清单
- [ ] 创建新任务
- [ ] 执行简单文件操作（读、写、编辑）
- [ ] 执行终端命令
- [ ] 使用不同 API 提供商
- [ ] 测试工具审批
- [ ] 测试任务暂停和恢复
- [ ] 测试历史记录

---

## 注意事项

### 1. 保持完整性
- **不要简化或省略**任何功能
- **不要重写**逻辑，只做必要适配
- **保留所有注释**和文档

### 2. 分层迁移
- 严格按照依赖关系迁移
- 确保每层都能独立验证
- 不要跳过基础模块

### 3. 问题记录
- 遇到问题立即记录
- 记录适配点和原因
- 记录性能问题

### 4. 性能考虑
- 大文件读取需要分块
- Tree-sitter 解析需要缓存
- API 调用需要节流

---

## 预计时间

### MVP 版本（6 周）
- **第 1 周**: 基础设施
- **第 2 周**: API 层
- **第 3-4 周**: 工具系统
- **第 5 周**: 任务核心
- **第 6 周**: UI 和集成

### 完整版本（10-12 周）
- **第 7-8 周**: 高级服务（Tree-sitter、代码索引等）
- **第 9-10 周**: 次要工具和服务
- **第 11-12 周**: 优化和完善

---

## 最终目标

### 功能完整性
- [ ] 所有 Kilocode 核心功能可用
- [ ] 支持所有工具
- [ ] 支持所有 API 提供商
- [ ] 三种模式（Chat/Agent/Architect）正常

### 集成完整性
- [ ] 显示在右侧边栏（AuxiliaryBar）
- [ ] 与现有 AI Chat 独立共存
- [ ] UI 交互流畅
- [ ] 符合 IDE 风格

### 性能和稳定性
- [ ] 启动时间 < 2 秒
- [ ] 内存占用合理
- [ ] 无内存泄漏
- [ ] 错误处理完善

---

## 参考资料

- **Kilocode 源码**: `/Users/caizhongrui/Downloads/kilocode-main/src/`
- **目标位置**: `src/vs/workbench/contrib/kilocode/`
- **Kilocode GitHub**: https://github.com/kilocode/kilocode
- **VSCode Views API**: https://code.visualstudio.com/api/extension-guides/tree-view
- **VSCode Webview API**: https://code.visualstudio.com/api/extension-guides/webview

---

## 总结

本计划涵盖 **55 个模块**，分 **7 个阶段**，预计 **6-12 周**完成。

**核心原则**：
1. 完全照抄 Kilocode，不改逻辑
2. 只做必要的路径和 API 适配
3. 作为内置功能集成（不是扩展）
4. 使用 ViewContainerLocation.AuxiliaryBar 显示在右侧
5. 与现有 AI Chat 完全独立

**成功标准**：
- Kilocode 完整功能在天和智开 IDE 中运行
- 显示在右侧边栏
- 与现有 AI Chat 和平共存
- 用户体验流畅自然

---

## 已完成模块详细记录

### ✅ 模块4：工具函数库 (2025-11-14)

**完成内容**：

#### 1. 核心文件（6个）

1. **`common/tools/toolTypes.ts`** - 工具类型定义
   - 定义了13种工具类型
   - 工具分组（read, edit, command）
   - 工具参数类型定义
   - 工具显示名称映射
   - 始终可用工具列表

2. **`common/tools/toolExecutor.ts`** - 工具执行器接口
   - `IToolExecutor` 接口定义
   - `ToolExecutionContext` 执行上下文
   - `ToolExecutionResult` 结果类型

3. **`browser/tools/fileOperations.ts`** - 文件操作工具
   - ✅ `readFile()` - 读取文件（支持行范围）
   - ✅ `writeToFile()` - 写入文件（创建/更新）
   - ✅ `listFiles()` - 列出文件（支持递归）
   - ✅ `fileExists()` - 检查文件存在
   - ✅ `getFileInfo()` - 获取文件信息

4. **`browser/tools/commandExecution.ts`** - 命令执行工具
   - ✅ `executeCommand()` - 执行终端命令
   - 自动创建终端实例
   - 支持指定工作目录
   - 使用`ITerminalService`

5. **`browser/tools/searchTools.ts`** - 搜索工具
   - ✅ `searchFiles()` - 搜索文件名
   - ✅ `codebaseSearch()` - 搜索代码内容
   - 📝 `listCodeDefinitionNames()` - 待实现（依赖Tree-sitter）
   - 使用`ISearchService`

6. **`browser/tools/toolExecutorImpl.ts`** - 工具执行器实现
   - 统一工具调度
   - 集成所有工具类
   - 错误处理
   - 工具可用性检查

#### 2. 已实现的工具（13种）

| 工具名称 | 功能 | 状态 |
|---------|------|------|
| `read_file` | 读取文件内容（支持行范围） | ✅ |
| `write_to_file` | 写入文件 | ✅ |
| `list_files` | 列出文件（支持递归） | ✅ |
| `execute_command` | 执行终端命令 | ✅ |
| `search_files` | 搜索文件名 | ✅ |
| `codebase_search` | 搜索代码内容 | ✅ |
| `list_code_definition_names` | 列出代码定义 | 📝 待实现 |
| `ask_followup_question` | 提问 | ✅ 基础实现 |
| `attempt_completion` | 完成任务 | ✅ 基础实现 |
| `new_task` | 创建新任务 | ✅ 基础实现 |
| `update_todo_list` | 更新待办列表 | ✅ 基础实现 |
| `edit_file` | 编辑文件 | 📝 待实现 |
| `insert_content` | 插入内容 | 📝 待实现 |

#### 3. 集成情况

✅ **MaxianService 已更新**：
```typescript
- 集成 ToolExecutorImpl
- 自动初始化工具系统
- 提供 executeTool() 方法
- 提供 getAvailableTools() 方法
- 获取工作区根目录作为默认cwd
```

#### 4. 编译和测试

- ✅ **编译成功**：0个错误
- ✅ **IDE启动**：成功
- ✅ **模块加载**：日志显示 "[Maxian] 码弦模块已加载"
- ✅ **视图渲染**：日志显示 "[Maxian] MaxianView UI 渲染完成"
- ✅ **用户测试**：可以发送消息

#### 5. 技术要点

**使用的VSCode内部API**：
- `IFileService` - 文件操作
- `ITerminalService` - 终端管理
- `ISearchService` - 搜索功能
- `IWorkspaceContextService` - 工作区上下文

**实现特点**：
- 所有工具类都是纯TypeScript实现
- 不依赖外部npm包
- 使用VSCode内置服务
- 完整的错误处理
- 类型安全

#### 6. 下一步

模块4已完成，按照迁移计划，下一个模块是：

**模块5：千问API适配层**
- 实现千问模型API对接
- 消息格式转换
- 流式响应处理
- 工具调用解析
- 使用智开的配置信息

---

### ✅ 模块5：千问API适配层 (2025-11-14)

**完成内容**：

#### 1. 核心文件（3个）

1. **`common/api/types.ts`** - API类型定义 (183行)
   - `MessageRole` - 消息角色类型 ('system', 'user', 'assistant', 'tool')
   - `ContentBlock` - 内容块联合类型 (TextContentBlock | ImageContentBlock | ToolUseContentBlock | ToolResultContentBlock)
   - `MessageParam` - 消息参数接口
   - `ToolDefinition` - 工具定义接口
   - `StreamChunk` - 流响应块类型 (TextStreamChunk | ToolUseStreamChunk | UsageStreamChunk | ErrorStreamChunk)
   - `ApiStream` - AsyncGenerator类型
   - `IApiHandler` - API处理器接口 (createMessage, getModel, countTokens)
   - `ModelInfo` - 模型信息接口
   - `ApiConfiguration` - API配置接口

2. **`common/api/qwenHandler.ts`** - 千问API处理器实现 (408行)
   - **模型定义**：
     * qwen-coder-turbo (maxTokens: 4096)
     * qwen3-coder-480b-a35b-instruct (maxTokens: 8192)
     * qwen-max (maxTokens: 8192, supportsVision: true)
     * qwen-plus (maxTokens: 8192)
   - **核心方法**：
     * `createMessage()` - 创建消息并返回流式响应
     * `processStream()` - 处理SSE格式的流式响应
     * `convertMessages()` - Maxian格式转千问格式
     * `convertTools()` - 工具定义转换
     * `countTokens()` - Token数量估算 (0.4 chars/token)
   - **API端点**: `https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions`
   - **特性**：
     * 流式响应处理（SSE）
     * 工具调用累积（处理分片工具参数）
     * 错误处理和超时控制
     * Token使用统计

3. **`common/api/apiFactory.ts`** - API工厂 (73行)
   - `createHandler()` - 根据配置创建API Handler
   - `validateConfiguration()` - 验证配置有效性
   - **读取智开配置**：
     * zhikai.ai.apiKey
     * zhikai.ai.model (默认: qwen-coder-turbo)
     * zhikai.ai.temperature (默认: 0.15)
     * zhikai.ai.maxTokens (默认: 1000)
     * zhikai.ai.timeout (默认: 30000ms)

#### 2. MaxianService集成

更新了 `browser/maxianService.ts`，添加：
- 导入 ApiFactory 和相关类型
- 添加 `apiHandler` 和 `apiFactory` 字段
- 添加 `messageHistory` 消息历史
- 注入 `IConfigurationService` 依赖
- **initialize()** 方法中初始化API Handler
- **sendMessage()** 方法实现完整对话循环：
  * 添加用户消息到历史
  * 调用 `conversationLoop()` 开始对话
- **conversationLoop()** 私有方法：
  * 准备工具定义
  * 调用API获取流式响应
  * 处理文本和工具调用
  * 执行工具并收集结果
  * 添加助手消息和工具结果到历史
  * 循环直到AI完成（最多25轮）
- **getSystemPrompt()** - 返回系统提示词
- **getToolDefinitions()** - 返回工具定义列表（简化版）

#### 3. 技术实现细节

**千问API对接**：
```typescript
// SSE格式解析
"data: {...}\n"
"data: [DONE]\n"

// 流式响应处理
for await (const chunk of stream) {
  if (chunk.type === 'text') {
    // 累积文本内容
  } else if (chunk.type === 'tool_use') {
    // 累积工具调用
  } else if (chunk.type === 'usage') {
    // 记录Token使用
  }
}
```

**消息格式转换**：
```typescript
// Maxian格式
{
  role: 'user',
  content: [
    { type: 'text', text: '...' },
    { type: 'tool_use', id: '...', name: '...', input: {...} }
  ]
}

// 千问格式
{
  role: 'user',
  content: '...'  // 只支持字符串
}

// tool结果转为user消息
```

**工具调用处理**：
```typescript
// 工具调用累积（处理分片）
const toolCallsMap = new Map<string, { name: string; arguments: string }>();

// 每个分片累积参数
toolCallsMap.get(toolId).arguments += argsFragment;

// finish_reason时输出完整工具调用
if (chunk.choices[0]?.finish_reason) {
  yield {
    type: 'tool_use',
    id: toolId,
    name: existing.name,
    input: existing.arguments
  };
}
```

#### 4. 编译和测试

- ✅ **编译成功**：0个错误
- ✅ **修复错误2个**：
  1. `apiFactory.ts:6` - IConfigurationService导入路径错误（../../../../../platform）
  2. `maxianService.ts:242` - executeTool参数缺少type和partial字段
- ✅ **类型检查通过**
- ✅ **集成验证**：MaxianService可以初始化API Handler

#### 5. 使用的VSCode内部API

- `IConfigurationService` - 读取配置信息

#### 6. 技术特点

- **无外部依赖**：使用原生fetch API，不依赖OpenAI SDK
- **流式处理**：AsyncGenerator模式，支持实时响应
- **错误处理**：
  * HTTP错误检测
  * JSON解析错误捕获
  * 超时控制 (AbortSignal.timeout)
  * 错误流块返回
- **类型安全**：完整的TypeScript类型定义
- **工具调用**：支持千问的function calling（OpenAI兼容格式）
- **Token统计**：简单但有效的Token估算算法

#### 7. 对话循环实现

```typescript
conversationLoop() {
  while (iteration < MAX_ITERATIONS) {
    // 1. 调用API
    const stream = apiHandler.createMessage(systemPrompt, messageHistory, tools);

    // 2. 处理响应
    for await (const chunk of stream) {
      // 累积文本和工具调用
    }

    // 3. 如果没有工具调用，结束循环
    if (toolUses.length === 0) break;

    // 4. 执行工具
    for (const toolUse of toolUses) {
      const result = await executeTool(toolUse);
      toolResults.push(result);
    }

    // 5. 添加结果到历史，继续循环
    messageHistory.push({ role: 'tool', content: toolResults });
  }
}
```

#### 8. 工具定义（简化版）

当前实现了3个基础工具定义：
- `read_file` - 读取文件内容
- `write_to_file` - 写入文件
- `execute_command` - 执行终端命令

**后续优化**：从工具注册表动态获取完整工具定义

#### 9. 下一步

模块5已完成，按照迁移计划，下一个模块是：

**模块6：提示词系统（简化版）**
- 基础系统提示词
- 包含工具描述
- 环境信息
- 任务规则

---

## Module 6 完成记录 - 提示词系统（完整版）

**完成时间**: 2025-11-14

### 实现概述

创建完整的系统提示词生成系统，参考Kilocode的实现，包含所有必要的sections和工具描述。

### 创建的文件

#### Section文件（5个）

1. **src/vs/workbench/contrib/maxian/common/prompts/sections/rules.ts**
   - 规则section
   - 包含文件操作、工具使用、代码质量、安全性、沟通规则等
   - 参考Kilocode的规则定义

2. **src/vs/workbench/contrib/maxian/common/prompts/sections/capabilities.ts**
   - 能力说明section
   - 包含文件系统操作、代码理解、命令执行、语义搜索、任务管理等能力

3. **src/vs/workbench/contrib/maxian/common/prompts/sections/systemInfo.ts**
   - 系统信息section
   - 包含操作系统、架构、Node.js版本、Shell类型、工作区路径等

4. **src/vs/workbench/contrib/maxian/common/prompts/sections/objective.ts**
   - 目标section
   - 定义Agent的工作目标和流程
   - 包含关键原则

5. **src/vs/workbench/contrib/maxian/common/prompts/sections/toolUseGuidelines.ts**
   - 工具使用指南section
   - 包含代码探索、文件操作、命令执行、搜索策略、任务管理等最佳实践

#### 核心文件（2个）

6. **src/vs/workbench/contrib/maxian/common/prompts/sections/index.ts**
   - Sections导出入口
   - 统一导出所有section函数

7. **src/vs/workbench/contrib/maxian/common/prompts/systemPrompt.ts**（重写）
   - 系统提示词生成器主类
   - 整合所有sections
   - 生成完整系统提示词

8. **src/vs/workbench/contrib/maxian/common/prompts/toolDescriptions.ts**
   - 工具描述生成器
   - 包含13种工具的详细描述
   - 每个工具包含：用途、参数、最佳实践、使用规则、例子等

### 系统提示词结构

完整的系统提示词包含以下部分：

1. **角色定义** - Agent的身份和核心能力
2. **工具使用说明** - 工具调用格式
3. **工具描述** - 13种工具的详细描述（195行）
4. **工具使用指南** - 最佳实践（7大类指南）
5. **能力说明** - Agent的5大能力
6. **规则** - 各类操作规则和约束
7. **系统信息** - 环境和配置信息
8. **目标** - 工作目标和流程

### 工具描述清单

包含以下13种工具的详细描述：

1. read_file - 读取文件
2. write_to_file - 写入文件
3. list_files - 列出目录
4. execute_command - 执行命令
5. search_files - 搜索文件
6. codebase_search - 语义搜索（关键）
7. ask_followup_question - 询问用户
8. attempt_completion - 完成任务
9. new_task - 创建子任务
10. update_todo_list - 更新待办列表
11. list_code_definition_names - 列出代码定义
12. insert_content - 插入内容
13. edit_file - 编辑文件

每个工具描述包含：
- 用途说明
- 参数定义
- 最佳实践
- 使用规则
- 示例（部分工具）

### 关键特性

1. **完整性** - 参考Kilocode实现，包含所有必要部分
2. **结构化** - 使用sections模块化组织
3. **详细** - 每个工具都有详细的使用说明
4. **实用** - 包含大量最佳实践和使用技巧
5. **清晰** - 分层次组织，易于理解

### 集成情况

- ✅ 已集成到 MaxianService
- ✅ getSystemPrompt() 使用 SystemPromptGenerator.generate()
- ✅ 动态获取工作区路径和可用工具
- ✅ 编译成功，无错误

### 代码统计

- Section文件: 5个（~400行）
- 核心文件: 3个（~320行）
- 总计: ~720行代码
- 工具描述: 13种工具，每个15-30行

### 验证标准

- ✅ 系统提示词可以正确生成
- ✅ 包含所有必要信息（8个sections）
- ✅ 所有工具都有详细描述
- ✅ 提示词结构清晰合理
- ✅ 参考Kilocode最佳实践
- ✅ 集成到MaxianService成功

### 与Kilocode的对比

**相同之处**：
- Section结构相同（rules、capabilities、systemInfo、objective等）
- 工具描述格式相似
- 规则和指南内容参考Kilocode

**差异**：
- 去除了MCP相关内容（码弦不支持MCP）
- 简化了模式切换（码弦只有Agent模式）
- 去除了浏览器自动化相关内容
- 只保留千问API相关配置
- 工具描述使用中文

### 下一步

可以继续实现：
- Module 7: 文件系统 - Glob
- Module 8: 文件系统 - Ripgrep
- Module 9: 工具基础设施
- ...

系统提示词系统已完成，为Agent的智能对话提供了完整的指导和规则。
