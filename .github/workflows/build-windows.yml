# GitHub Actions - Windows 构建工作流
name: Build Windows Installer

on:
  push:
    branches: [ main, maxian-agent-release, day2-complete-kilocode-migration ]
  pull_request:
    branches: [ main, maxian-agent-release ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: 安装依赖
      run: npm install
      env:
        ELECTRON_SKIP_BINARY_DOWNLOAD: 1
        PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

    - name: 下载内置扩展
      run: npm run download-builtin-extensions
      continue-on-error: true

    - name: 编译构建
      run: npm run compile-build

    - name: 编译扩展
      run: npm run compile-extensions-build

    - name: Bundle 和 Minify
      run: |
        npm run gulp bundle-vscode
        npm run gulp minify-vscode

    - name: 验证 out-vscode-min 目录
      run: |
        echo "检查 out-vscode-min 目录..."
        if (Test-Path "out-vscode-min") {
          echo "[OK] out-vscode-min 存在"
          Get-ChildItem "out-vscode-min" | Select-Object -First 10

          echo ""
          echo "检查关键文件 workbench.js..."
          if (Test-Path "out-vscode-min/vs/code/electron-sandbox/workbench/workbench.js") {
            $size = (Get-Item "out-vscode-min/vs/code/electron-sandbox/workbench/workbench.js").Length
            echo "[OK] workbench.js 存在, 大小: $size 字节"
            if ($size -lt 7000) {
              echo "[ERROR] 文件太小！应该约9000字节"
              exit 1
            }
          } else {
            echo "[ERROR] workbench.js 不存在！"
            exit 1
          }
        } else {
          echo "[ERROR] out-vscode-min 目录不存在 - minify 失败！"
          exit 1
        }
      shell: pwsh

    - name: 构建 Windows 客户端 (x64)
      run: |
        npm run gulp vscode-win32-x64-min-ci
        npm run gulp vscode-win32-x64-inno-updater

    - name: 生成系统级安装包
      run: npm run gulp vscode-win32-x64-system-setup

    - name: 生成用户级安装包
      run: npm run gulp vscode-win32-x64-user-setup

    - name: 上传系统级安装包
      uses: actions/upload-artifact@v4
      with:
        name: tianhe-zhikai-system-setup-x64
        path: .build/win32-x64/system-setup/VSCodeSetup.exe
        if-no-files-found: error

    - name: 上传用户级安装包
      uses: actions/upload-artifact@v4
      with:
        name: tianhe-zhikai-user-setup-x64
        path: .build/win32-x64/user-setup/VSCodeSetup.exe
        if-no-files-found: error

    - name: 打包绿色版（便携版）
      run: |
        Compress-Archive -Path .build/win32-x64/VSCode-win32-x64 -DestinationPath tianhe-zhikai-portable-x64.zip
      shell: pwsh

    - name: 上传绿色版
      uses: actions/upload-artifact@v4
      with:
        name: tianhe-zhikai-portable-x64
        path: tianhe-zhikai-portable-x64.zip
        if-no-files-found: error

    - name: 构建信息
      run: |
        echo "构建完成！"
        echo "系统级安装包: .build/win32-x64/system-setup/VSCodeSetup.exe"
        echo "用户级安装包: .build/win32-x64/user-setup/VSCodeSetup.exe"
        echo "绿色版（便携版）: tianhe-zhikai-portable-x64.zip"
        dir .build\win32-x64\system-setup\
        dir .build\win32-x64\user-setup\
        dir tianhe-zhikai-portable-x64.zip
