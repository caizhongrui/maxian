# GitHub Actions - Windows 构建工作流
name: Build Windows Installer

on:
  push:
    branches: [ main, maxian-agent-release, day2-complete-kilocode-migration, plan-f-direct-import ]
  pull_request:
    branches: [ main, maxian-agent-release ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: 安装依赖
      run: npm install
      env:
        ELECTRON_SKIP_BINARY_DOWNLOAD: 1
        PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

    - name: 下载内置扩展
      run: npm run download-builtin-extensions
      continue-on-error: true

    - name: 构建 Windows 客户端 (x64) - 修复Windows路径问题
      run: |
        npm run gulp vscode-win32-x64-min
        npm run gulp vscode-win32-x64-inno-updater

    - name: 生成系统级安装包
      run: npm run gulp vscode-win32-x64-system-setup

    - name: 生成用户级安装包
      run: npm run gulp vscode-win32-x64-user-setup

    - name: 上传系统级安装包
      uses: actions/upload-artifact@v4
      with:
        name: tianhe-zhikai-system-setup-x64
        path: .build/win32-x64/system-setup/VSCodeSetup.exe
        if-no-files-found: error

    - name: 上传用户级安装包
      uses: actions/upload-artifact@v4
      with:
        name: tianhe-zhikai-user-setup-x64
        path: .build/win32-x64/user-setup/VSCodeSetup.exe
        if-no-files-found: error

    - name: 打包绿色版（便携版）
      run: |
        Compress-Archive -Path .build/win32-x64/VSCode-win32-x64 -DestinationPath tianhe-zhikai-portable-x64.zip
      shell: pwsh

    - name: 上传绿色版
      uses: actions/upload-artifact@v4
      with:
        name: tianhe-zhikai-portable-x64
        path: tianhe-zhikai-portable-x64.zip
        if-no-files-found: error

    - name: 构建信息
      run: |
        echo "构建完成！"
        echo "系统级安装包: .build/win32-x64/system-setup/VSCodeSetup.exe"
        echo "用户级安装包: .build/win32-x64/user-setup/VSCodeSetup.exe"
        echo "绿色版（便携版）: tianhe-zhikai-portable-x64.zip"
        dir .build\win32-x64\system-setup\
        dir .build\win32-x64\user-setup\
        dir tianhe-zhikai-portable-x64.zip
